# Zoea Nova v1 Launch Plan

Comprehensive checklist to address all known issues, TODOs, and code analysis findings. Complete these items before production release.

---

## Phase 1: Critical Blockers

### 1.1 MCP Server Connection

The upstream SpaceMolt MCP server handshake was previously broken but is **now resolved** (verified 2026-02-05). Game tools are available. We will proceed with offline mode and retry logic for robustness.

- [x] **Verify upstream connection**
  - Result: Resolved (202 Accepted)
  - Verified: 2026-02-05 14:43 UTC

- [x] **Implement offline/stub mode for development**
  - Create `internal/mcp/stub.go` with mock game responses
  - Add `--offline` flag to run without upstream connection
  - Document in AGENTS.md how to develop without game server
  - Completed: 2026-02-05 15:10 UTC

- [x] **Add retry logic with exponential backoff**
  - Modify `internal/mcp/client.go` Initialize to retry 3x:w
  - Log each retry attempt
  - Graceful degradation if all retries fail
  - Completed: 2026-02-05 15:10 UTC

### 1.2 Failing Integration Tests

17 integration tests timeout consistently.

- [x] **Fix integration test pattern**
  - Update all tests to send quit before FinalModel()
  - Reference: `documentation/TUI_TESTING.md` quit pattern section
  - Files: `internal/tui/integration_test.go`
  - Completed: 2026-02-05 15:44 UTC

- [x] **Add integration test CI gate**
  - Makefile target: `make test-integration`
  - Fail build if any integration tests timeout
  - Completed: 2026-02-05 15:44 UTC

---

## Phase 2: Prompt & Behavior (High Priority)

### 2.1 State-Aware ContinuePrompt

Reduces redundant "waiting" responses during travel and cooldowns.

**Completed:** 2026-02-05 16:30 UTC

- [x] **Track mysis activity state**
  - Add `activityState` field to Mysis struct
  - States: `idle`, `traveling`, `mining`, `in_combat`, `cooldown`
  - Update state based on tool call results (travel, mine, attack)
  - Completed: 2026-02-05 16:30 UTC

- [x] **Suppress nudge during known wait states**
  - Modify `Mysis.run()` ticker logic
  - Skip ContinuePrompt if `activityState` is `traveling` or `cooldown`
  - Or extend interval (e.g., 2 minutes instead of 30s)
  - Completed: 2026-02-05 16:30 UTC

- [x] **Parse arrival_tick from tool results**
  - Extract `arrival_tick` from travel tool responses
  - Calculate wait duration from game tick time
  - Resume normal prompting after arrival
  - Completed: 2026-02-05 16:30 UTC

### 2.2 Reinforce Critical Rules in ContinuePrompt

Prevents drift when system prompt falls out of context window.

- [x] **Audit ContinuePrompt content**
  - Compare against SystemPrompt for missing rules
  - Add: collaboration rules, themed usernames, memory search

- [x] **Add context-aware reminders**
  - If recent messages show drift, include stronger reminders
  - Example: if mysis used real-world time, remind about game tick time

**Completed:** 2026-02-05 18:10 UTC

### 2.3 Remove Real-Time Awareness

- [x] **Audit SystemPrompt and ContinuePrompt**
  - Remove any references to real-world time
  - Replace with game tick time instructions

- [x] **Add game time tool if needed**
  - If myses need time awareness, expose `zoea_game_time` tool
  - Returns current tick from last server response
  - Not needed: prompts instruct using ticks from tool results (current_tick, arrival_tick, cooldown_ticks)

**Completed:** 2026-02-05 18:10 UTC

### 2.4 Captains Log Guidance

** NEEDS TO BE REVISED AND FIND EVIDENCE, UPSTREAM GAME SERVER HAS CHANGED**

Prevents `empty_entry` errors.

- [ ] **Verify current prompts have examples**
  - SystemPrompt already has examples (lines 55-59 of mysis.go)
  - ContinuePrompt has reminder (line 120-121)
  - Test with fresh mysis to confirm no empty_entry errors

---

## Phase 3: Concurrency & Reliability

### 3.1 EventBus Silent Drops

Events vanish without logging when buffer is full.

- [ ] **Add drop counter and logging**
  - Track dropped events per subscriber
  - Log warning every 100 dropped events
  - Include event type in log message

- [ ] **Consider backpressure option**
  - Add `PublishBlocking(event, timeout)` method
  - Use for critical events (errors, state changes)
  - Keep non-blocking for high-frequency events (messages)

### 3.2 Race Condition in Mysis.Stop()

Lock ordering between `mu` and `turnMu` allows interleaving.

- [ ] **Audit state machine transitions**
  - Document valid state transitions
  - Add tests for concurrent Start/Stop calls

- [ ] **Consider atomic state machine**
  - Replace `state` field with `atomic.Value` or dedicated state machine
  - Or hold both locks in Stop() before state check

### 3.3 Goroutine Leak in Nudge Ticker

The 30-second ticker spawns goroutines even when TryLock fails.

- [ ] **Refactor nudge logic**
  - Don't spawn goroutine if TryLock fails
  - Use channel-based signaling instead of goroutine per nudge

---

## Phase 4: Error Handling

### 4.1 Silent Error Swallowing

- [ ] **Fix proxy.go line 100**
  - Change `_ = err` to `log.Warn().Err(err).Msg("...")`

- [ ] **Fix mysis.go setErrorState**
  - Log error if store.UpdateMysisState fails
  - Consider emitting error event

- [ ] **Audit codebase for `_ = err`**
  - Run: `grep -n "_ = err" internal/`
  - Fix each occurrence with appropriate handling

### 4.2 Time Parsing Fragility

- [ ] **Fix memories.go time parsing**
  - Log warning when parse fails
  - Use consistent time format in all INSERTs
  - Add test for round-trip time storage

---

## Phase 5: Testing

### 5.1 Coverage Targets

Current: ~61%. Target: 80%+.

| Package | Current | Target |
|---------|---------|--------|
| `cmd/zoea` | 0.0% | 20% |
| `internal/config` | 52.5% | 80% |
| `internal/mcp` | 46.0% | 75% |
| `internal/provider` | 36.1% | 70% |
| `internal/store` | 77.1% | 85% |
| `internal/core` | 84.1% | 85% |

- [ ] **Add provider tests**
  - Test Ollama error handling paths
  - Test rate limiter behavior
  - Mock HTTP responses for tool calls

- [ ] **Add config validation tests**
  - Test invalid temperature values
  - Test missing required fields
  - Test environment override precedence

- [ ] **Add mcp proxy tests**
  - Test local tool routing
  - Test upstream fallback
  - Test auth interception

### 5.2 Mock Provider Delays

- [ ] **Add configurable delay to MockProvider**
  - `MockProvider.SetDelay(time.Duration)`
  - Use in integration tests to simulate real LLM latency

---

## Phase 6: Database & Performance

### 6.1 Memory Table Growth

No cleanup of old memories.

- [ ] **Analyze memory growth**
  - Run with 16 myses for 1 hour
  - Measure database size and query performance
  - Document findings

- [ ] **Implement retention policy (if needed)**
  - Option A: Keep last N memories per mysis (configurable)
  - Option B: Prune memories older than N days
  - Add `make db-prune` target

### 6.2 MaxOpenConns=1 Bottleneck

- [ ] **Benchmark concurrent writes**
  - Test with 16 myses writing simultaneously
  - Measure write latency and throughput
  - Document if acceptable for v1

- [ ] **Consider write queue (if needed)**
  - Batch writes from multiple myses
  - Single writer goroutine with channel input

---

## Phase 7: Configuration & Validation

### 7.1 Add Config Validation

- [ ] **Validate provider config**
  - Temperature: 0.0 - 2.0
  - RateLimit: > 0
  - RateBurst: >= 1
  - Endpoint: valid URL format

- [ ] **Validate swarm config**
  - MaxMyses: 1 - 100

- [ ] **Return validation errors from Load()**
  - Collect all errors, return joined
  - Include field name and invalid value in message

### 7.2 Reduce Config Boilerplate

- [ ] **Refactor applyEnvOverrides**
  - Table-driven approach for env var mapping
  - Reduce from 90 lines to ~30

---

## Phase 8: Code Quality

### 8.1 Type Safety Improvements

- [ ] **Replace Event.Data interface{}**
  - Option A: Separate event types per data struct
  - Option B: Sum type using generics
  - Option C: Keep interface{} but add helper methods

### 8.2 Consistent Receiver Names

- [ ] **Audit and standardize**
  - Mysis: `m` (not `a`)
  - Store: `s`
  - Proxy: `p`
  - Model: `m`

### 8.3 Centralize Constants

- [x] **Create internal/constants package or file**
  - Move magic numbers from mysis.go
  - Move timeouts and limits
  - Document each constant's purpose
  - Move all prompt templates to constants.go as well.
  - Completed: 2026-02-05 16:08 UTC

---

## Phase 9: Documentation

### 9.1 User Documentation

- [ ] **Add install command**
  - `make install` copies binary to ~/.zoea-nova/bin/
  - Update README with installation instructions

- [ ] **Document offline mode**
  - How to run without game server
  - What features are available in offline mode

### 9.2 Developer Documentation

- [ ] **Add architecture diagram**
  - Use mermaid in AGENTS.md
  - Show: Commander -> Mysis -> Provider -> LLM
  - Show: TUI -> EventBus -> Commander

- [ ] **Document state machine**
  - Valid Mysis state transitions
  - When each transition occurs

---

## Phase 10: TODO.md Items

From `documentation/TODO.md`:

- [ ] **Animate message input**
  - Add spinner or unicode animation while sending
  - Show progress indicator for broadcast

- [ ] **Make install command**
  - `make install` target (covered in Phase 9.1)

- [ ] **Fix mysis tick calculation**
  - Investigate "calculating tick wrong" issue
  - Parse arrival_tick correctly from travel responses
  - Relate to Phase 2.1 state-aware prompting

- [ ] **Check Ollama logs for loop stoppage**
  - Review Ollama server logs during mysis runs
  - Identify if model is returning stop token unexpectedly
  - May relate to prompt structure or temperature

---

## Phase 11: TUI Data Visibility & Test Gaps

Audit of TUI tests for missing or malformed data displays.

**Completed:** 2026-02-05 20:05 UTC

### 11.1 Missing Data in Test Fixtures

The following data fields exist in structs but lack adequate test coverage:

- [x] **MysisInfo.CreatedAt not displayed**
  - Field exists in `MysisInfo` struct (dashboard.go:21)
  - Not rendered in dashboard or focus view
  - Consider: Show age (e.g., "2h ago") or creation date in focus view info panel

- [x] **MysisInfo.LastMessage timestamp not shown**
  - `LastMessage` content is displayed but its timestamp isn't
  - Consider: Show "5m ago" next to last message in dashboard

- [x] **LogEntry.Timestamp not displayed**
  - Field exists in `LogEntry` struct (focus.go:20)
  - `renderLogEntryImpl` never uses `entry.Timestamp`
  - Tests pass timestamps but rendering ignores them
  - Add timestamp display to each log entry (e.g., "10:30:05")

- [x] **LogEntry.SenderID display incomplete**
  - `SenderID` tracked for broadcasts but only shows "SWARM:" prefix
  - Could show sender mysis name: "SWARM (mysis-2):"
  - Requires lookup from mysis list by ID

- [x] **SwarmMessageInfo sender not displayed**
  - Dashboard shows broadcast content and time but not sender
  - `store.BroadcastMessage.SenderID` is retrieved but not passed to `SwarmMessageInfo`
  - Add `SenderID` field to `SwarmMessageInfo` and display in dashboard

### 11.2 Test Data Consistency Issues

- [x] **Golden tests use hardcoded dates**
  - Tests use `time.Date(2026, 1, 15, ...)` which differs from current date
  - Consider: Document this is intentional for reproducibility
  - Or: Use relative time display to avoid date dependency

- [x] **MockProvider returns instant responses**
  - `MockProvider.Chat()` returns immediately
  - Real LLM calls take 1-30 seconds
  - Integration tests don't catch timing bugs
  - Add `SetDelay(time.Duration)` to MockProvider (covered in Phase 5.2)

- [x] **Test terminal size is fixed at 120x40**
  - `TestTerminalWidth = 120`, `TestTerminalHeight = 40`
  - No tests for narrow terminals (80x24) or wide terminals (200x60)
  - Add golden tests for different terminal sizes

### 11.3 Missing Visual Regression Tests

- [x] **No golden test for errored state mysis**
  - Tests cover running, idle, stopped states
  - Missing: errored state with LastError display

- [x] **No golden test for loading spinner states**
  - `loadingSet` passed to `RenderDashboard` but not tested in golden files
  - Add test with `loadingSet["mysis-id"] = true`

- [x] **No golden test for long mysis names**
  - Truncation at 16 chars tested implicitly
  - Add explicit test with 20+ char name to verify "..."

- [x] **No golden test for empty last message**
  - Dashboard shows `LastMessage` if present
  - Missing test for mysis with no messages yet

- [x] **No golden test for multiline broadcast content**
  - `SwarmMessageInfo.Content` is single-line normalized (`strings.ReplaceAll`)
  - No test verifying newlines are stripped

### 11.4 Integration Test Pattern Fixes

- [x] **17 tests fail due to FinalModel timeout**
  - Root cause: Tests don't send quit before FinalModel()
  - Affected tests (from test output):
    - `TestIntegration_DashboardNavigationUp`
    - `TestIntegration_FocusViewTransition`
    - `TestIntegration_HelpToggle`
    - `TestIntegration_BroadcastInput`
    - `TestIntegration_MessageInput`
    - (and 12 more)
  - Fix: Add `tm.Send(tea.KeyMsg{Type: tea.KeyRunes, Runes: []rune{'q'}})` before `FinalModel()`

- [x] **Document integration test pattern in TUI_TESTING.md**
  - Pattern documented but not consistently followed
  - Add checklist to test file header comments

**Completed:** 2026-02-05 18:22 UTC

### 11.5 Data Display Improvements

- [x] **Add timestamp to log entries**
  - Render format: `[10:30:05] AI: Response text...`
  - Update `renderLogEntryImpl` to include timestamp
  - Update golden files after change

- [x] **Add mysis count to focus view header**
  - Show "MYSIS: alpha (3 of 16)" or similar
  - Helps user understand swarm context when focused

- [x] **Add scroll position indicator**
  - Current: Shows "â†‘ SCROLLED" suffix
  - Better: Show "Line 45/120" or percentage
  - Update `RenderFocusViewWithViewport` and golden files

- [x] **Show broadcast sender in dashboard**
  - Current: "14:30:05 Hello everyone"
  - Better: "14:30:05 [mysis-1] Hello everyone"
  - Requires passing sender info through SwarmMessageInfo

**Completed:** 2026-02-05 20:05 UTC

---

## Phase 12: Pre-Release Checklist

### 12.1 Final Verification

- [ ] **Run full test suite**
  - `make test` passes
  - No failing integration tests
  - Coverage >= 80%
  - Latest run: 2026-02-05 18:22 UTC (pass)

- [ ] **Run linter**
  - `make fmt` produces no changes
  - No warnings from go vet

- [ ] **Manual testing**
  - Create 3 myses, run for 10 minutes
  - Send broadcasts, verify delivery
  - Focus view shows correct logs
  - Stop/start/delete work correctly

### 12.2 Release Process

- [ ] **Update version**
  - Increment version in accordance with versioning rules
  - Update CHANGELOG.md (if exists) or create release notes

- [ ] **Tag release**
  - `git tag -a v1.0.0 -m "Zoea Nova v1.0.0"`
  - `git push origin v1.0.0`

- [ ] **Update KNOWN_ISSUES.md**
  - Move completed items to Recently Resolved
  - Document any known v1 limitations

---

## Tracking

| Phase | Items | Completed | Blocked |
|-------|-------|-----------|---------|
| 1. Critical Blockers | 5 | 5 | 0 |
| 2. Prompt & Behavior | 7 | 7 | 0 |
| 3. Concurrency | 5 | 0 | 0 |
| 4. Error Handling | 4 | 0 | 0 |
| 5. Testing | 5 | 0 | 0 |
| 6. Database | 3 | 0 | 0 |
| 7. Configuration | 3 | 0 | 0 |
| 8. Code Quality | 3 | 1 | 0 |
| 9. Documentation | 4 | 0 | 0 |
| 10. TODO.md | 4 | 0 | 0 |
| 11. TUI Data Visibility | 19 | 19 | 0 |
| 12. Pre-Release | 5 | 0 | 0 |
| **Total** | **67** | **32** | **0** |

---

## Notes

- Phase 1 (MCP server) may block testing of game integration features
- Phases 2-4 can proceed in parallel
- Phase 11 (TUI) items can be worked in parallel with other phases
- Phase 12 depends on all other phases completing

---

## Timeline

**Plan created:** 2026-02-05 14:30 UTC

**Estimated completion:**
- Human solo: 3-4 weeks
- Human + AI assistant: 1-2 weeks
- Human + AI assistant (aggressive): 1 day (user's bet)

Let's see who wins.
